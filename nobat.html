<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—“ï¸ Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† | Ù…Ø±Ú©Ø² Ø°Ù‡Ù† Ø¢Ú¯Ø§Ù‡</title>
    
    <style>
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ */
        body {
            direction: rtl; 
            font-family: Tahoma, 'B Koodak', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f0f4f7;
            color: #333;
        }

        /* Ù‡Ø¯Ø± ÙˆØ¨Ø³Ø§ÛŒØª */
        .header {
            background-color: #006f79; 
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .header h1 { margin: 0 0 5px 0; font-size: 2.2rem; letter-spacing: 1px; }
        .header p { font-size: 1rem; opacity: 0.9; }

        /* Ù…Ø­ÙØ¸Ù‡ Ø§ØµÙ„ÛŒ Ùˆ Ú©Ø§Ø±Øª Ù†ÙˆØ¨Øª Ø¯Ù‡ÛŒ */
        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .section-card {
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .section-card h2 {
            color: #00796b;
            border-bottom: 2px solid #e0f2f1;
            padding-bottom: 15px;
            margin-top: 0;
            text-align: center;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ ÙØ±Ù… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #004d40;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #b2dfdb;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #00796b;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 121, 107, 0.3);
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ */
        .btn-submit {
            background-color: #00796b;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
        }
        .btn-submit:hover {
            background-color: #004d40;
            transform: translateY(-2px);
        }
        .btn-submit:disabled {
            background-color: #a7a7a7;
            cursor: not-allowed;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .message-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            font-weight: bold;
        }
        .message-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
            font-weight: bold;
        }

        /* Ú©Ø§Ø±Øª Ù†ÙˆØ¨Øª Ø¯Ù‡ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ */
        .appointment-card {
            border: 2px solid #00796b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            background-color: #f0ffff;
            box-shadow: 0 4px 10px rgba(0, 121, 107, 0.1);
            text-align: right; 
        }
        .appointment-card h3 {
            color: #004d40;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        .appointment-card div {
            padding: 8px 0;
            border-bottom: 1px dashed #b2dfdb;
            display: flex;
            justify-content: space-between;
        }
        .appointment-card div:last-child {
            border-bottom: none;
        }
        .appointment-card strong {
            color: #00796b;
        }

        /* ÙÙˆØªØ± */
        .footer { text-align: center; padding: 20px; background-color: #333; color: white; margin-top: 40px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ—“ï¸ Ø³ÛŒØ³ØªÙ… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</h1>
        <p>Ù„Ø·ÙØ§Ù‹ ÙØ±Ù… Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.</p>
    </header>

    <main class="container">
        <!-- Ø¨Ø®Ø´ Ù†ÙˆØ¨Øª Ø¯Ù‡ÛŒ Ù…Ø·Ø¨ -->
        <section id="appointment-section" class="section-card">
            <h2>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØ¨Øª Ù…Ø´Ø§ÙˆØ±Ù‡ Ø­Ø¶ÙˆØ±ÛŒ</h2>
            <p id="auth-status" class="message-error">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ (Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯)...</p>

            <form id="booking-form" style="display: none;">
                <div class="form-group">
                    <label for="fullName">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                    <input type="text" id="fullName" placeholder="Ù…Ø§Ù†Ù†Ø¯: Ø¹Ù„ÛŒ Ø­Ø³ÛŒÙ†ÛŒ" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label>
                    <input type="tel" id="phoneNumber" placeholder="Û°Û¹Û±Û²xxxxxxx" required>
                </div>
                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù…Ø´Ú©Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                    <textarea id="description" rows="3" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ"></textarea>
                </div>
                
                <button type="submit" class="btn-submit" id="book-button">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØ¨Øª Ù…Ø´Ø§ÙˆØ±Ù‡</button>
                
                <div id="booking-message"></div>
            </form>
        </section>
    </main>

  <footer class="footer">
        <p>Ù…Ø­Ù…Ø¯ Ø¬Ù„ÛŒÙ„ÙˆÙ†Ø¯ | ØªÙ„ÙÙ†: 09021385669 | &copy; Ú©Ù„ÛŒÙ‡ Ø­Ù‚ÙˆÙ‚ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ú©Øª ÙÙ†Ø§ÙˆØ±Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù„Ù…Ø§Ø³ Ù¾Ø§Ø±Ø³ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
    </footer>

    <!-- Firebase Imports and Logic (MUST be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, orderBy, serverTimestamp, setLogLevel, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Canvas (Ø¶Ø±ÙˆØ±ÛŒ) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ§ÛŒØ±Ø¨ÛŒØ³
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); 

        let currentUserId = null;

        // Ø¹Ù†Ø§ØµØ± UI
        const authStatusElement = document.getElementById('auth-status');
        const bookingForm = document.getElementById('booking-form');
        const bookButton = document.getElementById('book-button');
        const bookingMessageElement = document.getElementById('booking-message');
        
        // --- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ ---
        const APPOINTMENT_ADDRESS = "Ø´ÛŒØ±Ø§Ø² . Ø®ÛŒØ§Ø¨Ø§Ù† Ù…Ù„Ø§ØµØ¯Ø±Ø§ .Ø³Ø§Ø®ØªÙ…Ø§Ù† Ù…Ù‡Ø± Ø·Ø¨Ù‚Ù‡ 2";
        const APPOINTMENT_TIMES = ["10:00", "11:00", "12:00", "15:00", "16:00"]; // Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ
        // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ (0=ÛŒÚ©Ø´Ù†Ø¨Ù‡ ØªØ§ 6=Ø´Ù†Ø¨Ù‡). 1 ØªØ§ 4 ÛŒØ¹Ù†ÛŒ Ø¯ÙˆØ´Ù†Ø¨Ù‡ ØªØ§ Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡
        const WORKING_DAYS = [1, 2, 3, 4]; 
        
        // Ù…Ø³ÛŒØ± Firestore (Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øª Ù‡Ø§ Ø¨ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†)
        const APPOINTMENTS_PATH = `artifacts/${appId}/public/data/appointments`;


        // 1. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ØªØ§Ø±ÛŒØ®
        function toJalali(gregorianDate) {
            // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆØ² Ùˆ Ù…Ø§Ù‡
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return gregorianDate.toLocaleDateString('fa-IR', options);
        }

        function getJalaliDay(gregorianDate) {
            return gregorianDate.toLocaleDateString('fa-IR', { weekday: 'long' });
        }

        function isWorkingDay(date) {
            const dayOfWeek = date.getDay(); 
            return WORKING_DAYS.includes(dayOfWeek);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        // 2. ØªØ§Ø¨Ø¹ Ø³Ø§Ø®Øª Ú©Ø¯ Ø¹Ø¯Ø¯ÛŒ Ù†ÙˆØ¨Øª
        function generateNumericId(length = 6) {
            let result = '';
            const characters = '0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø±Ù‚Ù… Ø§ÙˆÙ„ ØµÙØ± Ù†Ø¨Ø§Ø´Ø¯ ØªØ§ Ø·ÙˆÙ„ Ø±Ø´ØªÙ‡ Ø­ÙØ¸ Ø´ÙˆØ¯
                if (i === 0) {
                    // Ø¨Ø±Ø§ÛŒ Ø±Ù‚Ù… Ø§ÙˆÙ„ØŒ Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† Û± ØªØ§ Û¹
                    result += characters.charAt(Math.floor(Math.random() * 9) + 1); 
                } else {
                    // Ø¨Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡ Ø§Ø±Ù‚Ø§Ù…ØŒ Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† Û° ØªØ§ Û¹
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }
            }
            return result;
        }

        // 3. Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ØªØ®ØµÛŒØµ Ù†ÙˆØ¨Øª
        function getNextAvailableSlot(lastAppointmentTimestamp) {
            // Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø¢ÛŒÙ†Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯
            let lastDate = new Date();
            let lastTimeIndex = -1; 
            
            if (lastAppointmentTimestamp) {
                lastDate = lastAppointmentTimestamp.toDate();
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø²Ù…Ø§Ù†ÛŒ Ù†ÙˆØ¨Øª Ø¢Ø®Ø±
                const bookedTime = lastDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                lastTimeIndex = APPOINTMENT_TIMES.findIndex(t => t === bookedTime);
            }

            let currentDate = new Date(lastDate);
            currentDate.setHours(0, 0, 0, 0); 
            
            let nextTimeIndex = lastTimeIndex + 1;

            // Ø§Ú¯Ø± Ù†ÙˆØ¨Øª Ø¢Ø®Ø± Ù…Ø§Ù„ Ø±ÙˆØ² Ù‚Ø¨Ù„ Ø¨ÙˆØ¯Ù‡ØŒ ÛŒØ§ Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø±Ø²Ø±Ùˆ Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Ù†ÙˆØ¨Øª Ø§ÙˆÙ„ Ø§Ù…Ø±ÙˆØ² Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (lastTimeIndex === -1 || currentDate.getTime() < new Date().setHours(0,0,0,0)) {
                currentDate = new Date(); // Ø´Ø±ÙˆØ¹ Ø§Ø² Ø²Ù…Ø§Ù† Ø­Ø§Ù„
                currentDate.setSeconds(0, 0); 
                nextTimeIndex = 0;
            } else if (nextTimeIndex > 0 && currentDate.getTime() < new Date().setHours(0,0,0,0)) {
                 // Ø§Ú¯Ø± Ù†ÙˆØ¨Øª Ø¢Ø®Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ Ø§Ø³ØªØŒ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø³Ø§Ø¹Øª Ø±ÙˆØ² Ø¨Ø¹Ø¯ Ø´Ø±ÙˆØ¹ Ú©Ù†
                currentDate = addDays(currentDate, 1);
                nextTimeIndex = 0;
            }


            // Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ùˆ Ø³Ø§Ø¹Øª Ù…Ù†Ø§Ø³Ø¨
            while (true) {
                // Ø§Ú¯Ø± Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø±ÙˆØ² ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø±ÙˆØ² Ø¨Ø¹Ø¯ Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
                if (nextTimeIndex >= APPOINTMENT_TIMES.length) {
                    currentDate = addDays(currentDate, 1);
                    nextTimeIndex = 0;
                }

                // Ø§Ú¯Ø± Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ Ø±ÙˆØ² Ø¨Ø¹Ø¯ Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
                if (!isWorkingDay(currentDate)) {
                    currentDate = addDays(currentDate, 1);
                    nextTimeIndex = 0; 
                    continue; 
                }
                
                const nextTime = APPOINTMENT_TIMES[nextTimeIndex];
                const [hour, minute] = nextTime.split(':').map(Number);
                
                // ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ú©Ø§Ù…Ù„ Ù†ÙˆØ¨Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
                let proposedDate = new Date(currentDate);
                proposedDate.setHours(hour, minute, 0, 0);

                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù†ÙˆØ¨Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø³Øª
                if (proposedDate.getTime() > new Date().getTime()) {
                    return proposedDate;
                }
                
                // Ø§Ú¯Ø± Ù†ÙˆØ¨Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ú¯Ø°Ø´ØªÙ‡ØŒ Ø¨Ù‡ Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø±ÙˆØ² Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
                nextTimeIndex++;
            }
        }
        
        // 4. ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        function displayMessage(element, message, type = 'success') {
            element.textContent = message;
            element.className = `message-box message-${type}`;
        }
        
        // 5. ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª
        async function bookAppointment(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                displayMessage(bookingMessageElement, "Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'error');
                return;
            }

            bookButton.disabled = true;
            bookButton.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø±Ø²Ø±Ùˆ...";
            bookingMessageElement.innerHTML = ''; 

            try {
                const fullName = document.getElementById('fullName').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                const description = document.getElementById('description').value;

                if (!fullName || !phoneNumber) {
                    throw new Error("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                }

                // Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡
                let lastAppointmentTimestamp = null;
                const lastQuery = query(
                    collection(db, APPOINTMENTS_PATH),
                    orderBy('appointmentDate', 'desc'),
                    limit(1)
                );
                
                const querySnapshot = await getDocs(lastQuery);
                if (!querySnapshot.empty) {
                    lastAppointmentTimestamp = querySnapshot.docs[0].data().appointmentDate;
                }

                // Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ÙˆØ¨Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨Ø¹Ø¯ÛŒ
                const nextDate = getNextAvailableSlot(lastAppointmentTimestamp);

                // Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ…: Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯
                const newAppointmentRef = doc(collection(db, APPOINTMENTS_PATH)); 
                const appointmentData = {
                    fullName,
                    phoneNumber,
                    description,
                    userId: currentUserId,
                    appointmentDate: nextDate, // ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ (Date Object)
                    bookedAt: serverTimestamp(),
                    appointmentId: generateNumericId(6), // Ú©Ø¯ Ù†ÙˆØ¨Øª Û¶ Ø±Ù‚Ù…ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯
                    address: APPOINTMENT_ADDRESS,
                    status: 'Pending'
                };
                
                // Ù…Ø±Ø­Ù„Ù‡ Ú†Ù‡Ø§Ø±Ù…: Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Firestore
                await setDoc(newAppointmentRef, appointmentData);

                // Ù…Ø±Ø­Ù„Ù‡ Ù¾Ù†Ø¬Ù…: Ù†Ù…Ø§ÛŒØ´ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
                displayMessage(bookingMessageElement, "Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø²Ø±Ùˆ Ø´Ø¯!", 'success');
                renderAppointmentCard(appointmentData);

            } catch (error) {
                console.error("Booking Error:", error);
                let errorMessage = error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡.';
                if (errorMessage.includes("permission denied")) {
                     errorMessage = "Ø®Ø·Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø´Ù…Ø§ Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ Ù†Ù‚Ø¶ Ø´Ø¯Ù‡ Ø§Ø³Øª.";
                }
                displayMessage(bookingMessageElement, `Ø®Ø·Ø§ Ø¯Ø± Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª: ${errorMessage}`, 'error');
            } finally {
                bookButton.disabled = false;
                bookButton.textContent = "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØ¨Øª Ù…Ø´Ø§ÙˆØ±Ù‡";
            }
        }

        // 6. ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ú©Ø§Ø±Øª ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
        function renderAppointmentCard(data) {
            // data.appointmentDate Ø¯Ø± Ø²Ù…Ø§Ù† Ø«Ø¨Øª Ù…ÙˆÙÙ‚ØŒ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª Date Ø§Ø³ØªØŒ Ø¯Ø± Ø²Ù…Ø§Ù† Ù„ÙˆØ¯ Ø§Ø² ÙØ§ÛŒØ±Ø¨ÛŒØ³ØŒ ÛŒÚ© Timestamp Ø§Ø³Øª.
            const dateObj = data.appointmentDate.toDate ? data.appointmentDate.toDate() : data.appointmentDate; 
            const jalaliDate = toJalali(dateObj);
            // const dayName = getJalaliDay(dateObj); // Ø­Ø°Ù Ø´Ø¯ - Ù†Ø§Ù… Ø±ÙˆØ² Ø¯Ø± jalaliDate Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
            const time = dateObj.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', hour12: false }); 

            const cardHtml = `
                <div class="appointment-card">
                    <h3>âœ… ØªØ§ÛŒÛŒØ¯ Ù†ÙˆØ¨Øª Ø´Ù…Ø§</h3>
                    <div>
                        <span>Ú©Ø¯ Ù†ÙˆØ¨Øª:</span>
                        <strong>${data.appointmentId}</strong>
                    </div>
                    <div>
                        <span>Ù…Ø´Ø§ÙˆØ±:</span>
                        <span>Ø¯Ú©ØªØ± Ø³Ø§Ø±Ø§ Ø´ÙÛŒØ¹ÛŒ</span>
                    </div>
                    <div>
                        <span>ØªØ§Ø±ÛŒØ®:</span>
                        <span>${jalaliDate}</span>
                    </div>
                    <!-- Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆØ² Ø­Ø°Ù Ø´Ø¯ Ø²ÛŒØ±Ø§ ØªØ§Ø¨Ø¹ toJalali Ø¢Ù† Ø±Ø§ Ø¯Ø± Ù‚Ø³Ù…Øª 'ØªØ§Ø±ÛŒØ®' Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ -->
                    <div>
                        <span>Ø³Ø§Ø¹Øª:</span>
                        <span>${time}</span>
                    </div>
                    <div>
                        <span>Ø¢Ø¯Ø±Ø³ Ù…Ø·Ø¨:</span>
                        <strong style="text-align: left;">${data.address}</strong>
                    </div>
                </div>
            `;
            bookingMessageElement.innerHTML += cardHtml;
        }

        // 7. Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª (Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Firestore)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authStatusElement.textContent = `ÙˆØ¶Ø¹ÛŒØª: ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚. Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: ${currentUserId.substring(0, 8)}... (Ú©Ø§Ù…Ù„ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„)`;
                authStatusElement.className = "message-box message-success";
                bookingForm.style.display = 'block';
            } else {
                try {
                    authStatusElement.textContent = "Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…...";
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Ø§Ú¯Ø± ØªÙˆÚ©Ù† Ù†Ø¨ÙˆØ¯ØŒ ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                    authStatusElement.textContent = `Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ù…ÙˆÙ‚ØªØ§Ù‹ ØºÛŒØ± ÙØ¹Ø§Ù„ Ø§Ø³Øª.`;
                    authStatusElement.className = "message-box message-error";
                    bookingForm.style.display = 'none';
                }
            }
        });

        // 8. Ø§ØªØµØ§Ù„ ÙØ±Ù… Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ø±Ø²Ø±Ùˆ
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('booking-form').addEventListener('submit', bookAppointment);
        });

    </script>
</body>
</html>